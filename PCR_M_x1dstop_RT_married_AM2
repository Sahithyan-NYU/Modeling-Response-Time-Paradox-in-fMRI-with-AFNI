#!/bin/csh

# ---------------------------------------------------------------------------------
# Author: Sahithyan (emotion and cognition lab, IISc; Hatley Lab, NYU)
# Date: 2025-02-14
# Description:
# This script processes individual subject data for a project located at /media/cogemolab/home2/PCR. 
# The script:
# 1. Accepts a subject identifier as an argument (passed as $1).
# 2. Creates a specific directory structure for the subject's activation analysis.
# 3. Uses the 3dDeconvolve tool to perform a deconvolution analysis on the subject's functional MRI data.
# 4. Outputs the deconvolution results (design matrix with AM output) in both X1D format and PNG image for visualization.
# 5. Further processes the 1D time series file to clean and center the data.
# ---------------------------------------------------------------------------------

# Set project and template directories
set proj_path=/media/cogemolab/home2/PCR
set temp_path=/media/cogemolab/home2/templates

# Set the subject code passed as an argument
set subj=$1

# Set the path to the regressor files for the subject
set reg_path=$proj_path/data/individual/PCR"$subj"/regressors/activation/mainTask

# Create a directory structure for the subject's activation analysis if it doesn't already exist
mkdir -p $proj_path/data/individual/PCR"$subj"/activation/wholeBrain/mainTask/AM2

# Change directory to the newly created folder where results will be stored
cd $proj_path/data/individual/PCR"$subj"/activation/wholeBrain/mainTask/AM2

# Run 3dDeconvolve for deconvolution analysis
# -overwrite: Overwrites any existing output files
# -input: The functional MRI data (in MNI space)
# -mask: The brain mask (in MNI space)
# -concat: Specifies the concatenation of time points for the analysis
# -polort A: Polynomial regression model for detrending
# -nobout: Suppresses output of beta coefficients for each stimulus
# -noFDR: Disables False Discovery Rate correction
# -num_stimts 1: Specifies the number of stimulus time series
# -local_times: Uses local time units for stimuli
# -stim_times_AM2: The regressor file for the task onset and reaction time
# -stim_label: Labels the stimulus in the analysis
# -x1D: Specifies the X-matrix output file
# -xsave: Saves the X-matrix to a file
# -xjpeg: Saves a JPEG image of the X-matrix design
# -x1D_stop: Stops processing after the X-matrix is computed

3dDeconvolve \
    -overwrite \
    -input $proj_path/data/individual/PCR"$subj"/func/mainTask/PCR"$subj"_M_TR_MNI_3mm_SI.nii.gz \
    -mask $temp_path/MNI152_T1_3mm_brain_GM_02182017.nii.gz \
    -concat '1D: 0 186 372 558 744 930' \
    -polort A \
    -nobout \
    -noFDR \
    -num_stimts 1 \
    -local_times \
    -stim_times_AM2 1 $reg_path/M_TaskOnset_RT_married_PCR"$subj" 'GAM(8.6,0.547,1)' -stim_label 1 M_RT_Married_AM2 \
    -x1D ./"PCR"$subj"_M_RT_married_AM2_CueDeconvTaskMR.x1D" \
    -xsave \
    -xjpeg ./"PCR"$subj"_M_RT_married_AM2_CueDeconvTaskMR.png" \
    -x1D_stop

# Clean up the output 1D file generated by 3dDeconvolve by removing unwanted columns
1dcat PCR"$subj"_M_RT_married_AM2_CueDeconvTaskMR.x1D > PCR"$subj"_M_RT_married_AM2_CueDeconvTaskMR_clean.x1D

# Extract and center the mean of the regressor time series 
1dcat PCR"$subj"_M_RT_married_AM2_CueDeconvTaskMR_clean.x1D'[31]' > RT_regressor_mean_centered_PCR"$subj".1D #make sure you select the correct column number

